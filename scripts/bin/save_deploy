#!/bin/bash

. /etc/xdtrc

MACHINE="m3ulcb"
EXCLUDE="*ostree* *otaimg *tar.xzv *wic*"
DEPLOYDIR="${XDT_BUILD}/${MACHINE}/tmp/deploy/images/${MACHINE}/"
SAVEDIR="${XDT_DIR}/deploy/${MACHINE}/"

function usage() {
	cat <<EOF >&2
Options:
   -d|--deploy-dir
      deploy directory
      default: $DEPLOYDIR
   -m|--machine
      deploy machine
      default: $MACHINE
   -s|--savedir
      save directory
      default: $SAVEDIR
   -e|--excludeDeploy
      exclude Deploy
      default: $EXCLUDE
   -h|--help
      get this help

Example:
	$SCRIPT -f iotbzh/master -o /tmp/xdt -l /ssd/mirror -p /vol/xdt/proprietary-renesas-rcar/ -t porter agl-demo
EOF
	exit 1
}

while (($#)); do
	case "$1" in
		-d|--deploy-dir)
			DEPLOYDIR="$2";
			echo DEPLOYDIR $DEPLOYDIR
			shift 2;;
		-m|--machine)
			MACHINE="$2";
			shift 2;;
		-s|--savedir)
			SAVEDIR="$2";
			shift 2;;
		-e|--excludeDeploy)
			EXCLUDE="$2";
			shift 2;;
		-h|--help)
			HELP=1;
			shift;
			break;;
		--)
			shift;
			break;;
		*)
			echo "Internal error";
			exit 1;;
	esac
done

[[ "$HELP" == 1 ]] && usage

if [[ ! -d "${DEPLOYDIR}" ]] ; then
	echo "No deploy directory for board ${MACHINE} ($DEPLOYDIR)"
	exit 1;
fi

DEPLOYDIR=$(realpath ${DEPLOYDIR})

mkdir -p ${SAVEDIR}

if ! [[ -z "${EXCLUDE}" ]] ; then
	RSYNCEXCLUDE=""
	echo EXCLUDE "${EXCLUDE}"
	for e in ${EXCLUDE}; do
		RSYNCEXCLUDE="${RSYNCEXCLUDE} --exclude "$e" "
	done
fi

SAVEDIR=$(realpath ${SAVEDIR})
BASESAVEDIR=$(basename "${SAVEDIR}")
DIRSAVEDIR=$(dirname "${SAVEDIR}")

set -x
rsync -av --delete ${RSYNCEXCLUDE} ${DEPLOYDIR}/ ${SAVEDIR}/
set +x

rm -fr ${DIRSAVEDIR}/${MACHINE}_latest
ln -sf ${BASESAVEDIR} ${DIRSAVEDIR}/${MACHINE}_latest

echo "SAVEDIR here: ${SAVEDIR}"
