#!/bin/bash

BUILD_FLAVOUR=iotbzh
BUILD_MACHINES="porter m3ulcb qemux86-64 raspberrypi3 intel-corei7-64"

. /etc/xdtrc

# source conf file for this script if any
CONF=$(basename $0).conf
for x in /etc/$CONF $XDT_DIR/$CONF $HOME/$CONF; do
	[[ -f $x ]] && { echo "Loading config file $x"; . $x; }
done

LOG=$XDT_DIR/build/build_all.log

rm -rf $XDT_BUILD/tmp/
rm -f $LOG

function runbitbake() {
	bitbake "$@" 
	rc=$?
	eval $(bitbake -e | grep ^MACHINE_ARCH)
	echo ${MACHINE_ARCH:-unknown} $BUILD_FLAVOUR $([[ $rc == 0 ]] && echo "OK" || echo "FAIL($rc)") >>$LOG
	return $rc
}

baseopts="-f $BUILD_FLAVOUR -o $XDT_DIR -l $HOME/mirror/ -e wipeconfig"
extraopts=""

for machine in $BUILD_MACHINES; do
	case $machine in
		porter|m3ulcb|h3ulcb)
			opts="$baseopts -t $machine -p $HOME/mirror/proprietary-renesas-r-car/ $extraopts"
			;;
		*)
			opts="$baseopts -t $machine $extraopts"
			;;
	esac

	prepare_meta $opts 
	echo 'INHERIT += "rm_work"' >>$XDT_BUILD/conf/local.conf
	. $XDT_BUILD/agl-init-build-env
	runbitbake agl-demo-platform-crosssdk
			
	# add option "keepcache" after first build
	extraopts="-e keepcache"
done

echo "=========== BUILD SUMMARY ============"
cat $LOG
