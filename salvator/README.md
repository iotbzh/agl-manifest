# AGL build for Salvator-X

## Step 1: install docker container for builds

Follow the [quick guide](http://docs.automotivelinux.org/docs/getting_started/en/dev/#sdk-quick-setup)

For more details, check the [detailed guide here](http://docs.automotivelinux.org/docs/devguides/en/dev/)

## Step 2: prepare the build (non official method)

### Proprietary drivers

Prepare the Renesas R-Car Gen3 drivers, and put them in /home/devel/mirror/proprietary-renesas-r-car/ (or another folder and ajust the command line below)

### Build caches

For better build times, you can use caches. 
After a successful build, copy some folders from /xdt to /home/devel/mirror (or another folder and adjust command line below), then reuse them in successive calls to prepare_meta. 

The mirror folder may contain the following subfolders:

* 'meta' for a copy of all layers (= a copy of /xdt/meta)
* 'downloads' for a copy of the download dir (= a copy of /xdt/downloads)
* 'sstate-cache' for a copy of the sstate cache (= a copy of /xdt/sstate-cache)

### Extra hints for caches

After the first call to prepare_meta, agl-manifest (this repo) will be pulled into /xdt/meta/agl-manifest. From there, you can run the script /xdt/meta/agl-manifest/scripts/install_scripts : this will install some extra (non-official) scripts into /home/devel/bin.

The script 'sync_from_xdt' can be used to synchronize the mirror AFTER a successful build. This will copy the folders /xdt/meta, /xdt/downloads and /xdt/sstate-cache to /home/devel/mirror using rsync. Next prepare_meta invocation will do the opposite: it will sync /home/devel/mirror (or another folder specified with -l) to /xdt/ for the upcoming build.

The idea behind is to have /home/devel/mirror always clean. That way, if ever the sstate-cache goes mad because of a bad change in recipes, it's always possible to re-run prepare_meta to "rollback" into a clean state (with caches!).

Also, if the script [create_container](https://git.automotivelinux.org/AGL/docker-worker-generator/tree/contrib/create_container) has been used to initialize the container, /home/devel/mirror should be an external volume (from docker POV). So the same mirror can be reused/shared amongst multiple containers on the same machine.

### Prepare environment (IoT.bzh way)

Finally, to prepare for salvator, just run:
```
# prepare_meta -f salvator -o /xdt -l /home/devel/mirror/ -e wipeconfig -e cleartemp -e rm_work -t salvator -p /home/devel/mirror/proprietary-renesas-r-car/
```

*Notes:*

Using prepare_meta is not the official way of building AGL because the procedure doesn't use the (bloated!) repo tool. Instead, this procedure is maintained by IoT.bzh to achieve better stability and reproductiblity while still allowing newer (unofficial) developments.to be 'inserted'. The manifests are expressed as simple text files (see the [manifest file for master flavour](https://github.com/iotbzh/agl-manifest/blob/master/master/agl.manifest) as an example.

For the Salvator board, the flavour 'salvator' has been created in agl-manifest. It will pull the usual AGL layers (master branch) + some additional ones (meta-iot-agl) which will expose the new machine 'salvator'.

## Step 3: run the build

From this step we're back on the 'normal' build procedure for AGL.

Source the environment generated by aglsetup:

```
# . /xdt/build/salvator/agl-init-build-env
# bitbake agl-demo-platform-crosssdk
```

Result should be available in '/xdt/build/salvator/tmp/deploy/images/salvator-x/'

Then the procedure using the script 'mksdcard' (available inside docker container) can be used to create a bootable SDcard. Alternatively, using netboot should also be possible using the procedure documented in meta-agl/meta-netboot.

